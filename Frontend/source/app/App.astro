---
import "@shared/styles/global.sass";
import Fonts from "@shared/ui/Fonts/Fonts.astro";
import Sidebar from "@widgets/Sidebar/Sidebar.astro";
import Preloader from "@features/Preloader/Preloader.astro";
import { ViewTransitions, fade } from "astro:transitions";

interface Props {
	title: string;
	description?: string;
	activePage?: string;
}

const {
	title,
	description = "EchoAmazon - Your one-stop shop",
	activePage,
} = Astro.props;

// Base layout component wrapping all pages
// Handles global styles, fonts, theme persistence, and view transitions
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>

		<!-- Global Fonts & Transitions -->
		<Fonts />
		<ViewTransitions />

		<!-- Theme Handling (Dark/Light Mode) -->
		<script is:inline>
			// Function to apply the correct theme based on local storage or system preference
			function applyTheme() {
				const systemTheme = window.matchMedia("(prefers-color-scheme: dark)")
					.matches
					? "dark"
					: "light";
				const savedTheme = localStorage.getItem("theme");

				// Apply saved theme or fallback to system preference
				if (savedTheme) {
					document.documentElement.setAttribute("data-theme", savedTheme);
				} else {
					document.documentElement.setAttribute("data-theme", systemTheme);
				}
			}

			// Apply on initial load
			applyTheme();

			// Re-apply after View Transition swap to persist theme
			document.addEventListener("astro:after-swap", applyTheme);
		</script>
	</head>
	<body>
		<!-- Global Preloader -->
		<Preloader />

		<!-- Main App Layout: Sidebar + Content Area -->
		<div class="app-layout">
			<Sidebar activePage={activePage} />
			<main
				class="main-content"
				transition:animate={fade({ duration: "0.3s" })}
			>
				<slot />
			</main>
		</div>
	</body>
</html>

<style lang="sass">
	@use '@shared/styles/vars' as *

	.app-layout
		display: flex
		min-height: 100vh
		position: relative

	.main-content
		flex-grow: 1
		width: 100%
		padding: 1rem
		padding-top: 4rem // Space for toggle button on mobile
		transition: width 0.3s ease-in-out, margin-left 0.3s ease-in-out, padding 0.3s ease-in-out, transform 0.3s ease-in-out

		@include respond-to($tablet)
			padding: 2rem
			padding-top: 2rem
			width: calc(100% - 160px) // Sidebar (120px) + Gap (40px)
			margin-left: 160px // Sidebar (120px) + Gap (40px)

			// When sidebar is closed (body has .sidebar-toggled)
			:global(body.sidebar-toggled) &
				width: calc(100% - 40px) // Gap (40px)
				margin-left: 40px // Gap (40px)

		// Mobile: Shift content when sidebar is open
		@media (max-width: 767px)
			:global(body.sidebar-toggled) &
				transform: translateX(100px) // Shift by sidebar width
</style>
