---
import { Icon } from "astro-icon/components";
import Button from "@shared/ui/Button/Button.astro";

// Product Quick View Widget (Half View)
// Displays a slide-in overlay with product details
// Features: Image with hotspots, thumbnail gallery, size selector, "Go to full view" link
---

<div class="quick-view-overlay" id="quick-view-overlay">
	<div class="quick-view-backdrop" id="quick-view-backdrop"></div>
	<div class="quick-view-panel">
		<button
			class="close-btn"
			id="quick-view-close"
			aria-label="Close quick view"
		>
			<Icon name="close" size={24} />
		</button>

		<div class="quick-view-content">
			<!-- Product Image Section -->
			<div class="product-image-section">
				<div class="main-image-container">
					<img src="" alt="Product Image" id="qv-image" class="qv-main-image" />

					<!-- Image Shadow -->
					<div class="image-shadow"></div>
				</div>

				<!-- Gallery Navigation Indicators -->
				<div class="gallery-indicators">
					<span class="indicator active"></span>
					<span class="indicator"></span>
					<span class="indicator"></span>
				</div>

				<!-- Thumbnail Gallery -->
				<div class="thumbnail-gallery" id="qv-thumbnails">
					<!-- Thumbnails injected via JS -->
				</div>
			</div>

			<!-- Product Details Section -->
			<div class="product-details-section">
				<div class="qv-header">
					<p class="qv-brand" id="qv-brand">Brand</p>
					<h2 class="qv-title" id="qv-title">Product Title</h2>

					<div class="qv-rating">
						<div class="stars" id="qv-stars">
							<!-- Stars injected via JS -->
						</div>
					</div>
				</div>

				<div class="qv-description">
					<p id="qv-description">
						Experience unparalleled luxury with this exquisite cashmere jacket.
						Crafted from the finest Italian cashmere, this piece represents the
						pinnacle of sartorial elegance. The timeless design features
						meticulous hand-stitched detailing, mother of pearl buttons, and a
						full canvas construction that ensures a perfect drape. Perfect for
						those who appreciate the finer things in life.
					</p>
				</div>

				<div class="qv-sizes">
					<span class="size-option" data-size="XS">XS</span>
					<span class="size-option" data-size="S">S</span>
					<span class="size-option" data-size="M">M</span>
					<span class="size-option" data-size="L">L</span>
					<span class="size-option selected" data-size="XL">XL</span>
				</div>

				<div class="qv-actions">
					<div class="price-block">
						<span class="label">Best Price</span>
						<span class="price" id="qv-price">$0.00</span>
					</div>
					<Button
						text="Add To Cart"
						color="primary"
						variant="smooth"
						class="add-to-cart-btn"
					/>
				</div>

				<!-- Full View Link -->
				<a href="#" id="qv-full-view-link" class="full-view-link">
					<div class="text-content">
						<span class="title">Go to full view</span>
						<span class="subtitle">To check all good details</span>
					</div>
					<Icon name="arrow-right" size={20} />
				</a>
			</div>
		</div>
	</div>
</div>

<style lang="sass">
	@use '@shared/styles/vars' as *

	.quick-view-overlay
		position: fixed
		top: 0
		left: 0
		width: 100%
		height: 100%
		z-index: 2000
		pointer-events: none
		opacity: 0
		transition: opacity 0.3s ease

		&.active
			pointer-events: auto
			opacity: 1

			.quick-view-panel
				transform: translateX(0)

	.quick-view-backdrop
		position: absolute
		top: 0
		left: 0
		width: 100%
		height: 100%
		background-color: rgba(0, 0, 0, 0.5)
		backdrop-filter: blur(4px)
		cursor: pointer

	.quick-view-panel
		position: absolute
		top: 1rem
		right: 1rem
		bottom: 1rem
		width: 100%
		max-width: 70%
		height: calc(100% - 2rem)
		background-color: var(--bg-color)
		box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15)
		transform: translateX(calc(100% + 2rem))
		transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1)
		display: flex
		flex-direction: column
		overflow-y: auto
		border-radius: 24px
		border: 1px solid var(--border-color)

		@media (max-width: 1024px)
			max-width: 85%

		@media (max-width: 768px)
			max-width: 100%
			top: 0
			right: 0
			bottom: 0
			height: 100%
			border-radius: 0
			border: none
			transform: translateX(100%)

	.close-btn
		position: absolute
		top: 1.5rem
		right: 1.5rem
		background: transparent
		border: none
		color: var(--secondary-text-color)
		cursor: pointer
		z-index: 10
		transition: color 0.2s ease, transform 0.2s ease
		padding: 0.5rem

		&:hover
			color: var(--text-color)
			transform: scale(1.1)

	.quick-view-content
		display: flex
		flex-direction: column
		flex-grow: 1
		padding: 2rem
		gap: 2rem

		@include respond-to($tablet)
			flex-direction: row
			padding: 2rem
			gap: 2rem

	// === Product Image Section ===
	.product-image-section
		flex: 1.2
		display: flex
		flex-direction: column
		height: 100%
		gap: 1rem

	.main-image-container
		position: relative
		border-radius: 24px
		padding: 2rem
		display: flex
		align-items: center
		justify-content: center
		flex: 7
		min-height: 0

	.qv-main-image
		max-width: 100%
		max-height: 100%
		object-fit: contain
		filter: drop-shadow(0 15px 30px rgba(0,0,0,0.1))
		transition: transform 0.3s ease

	.image-shadow
		position: absolute
		bottom: 10%
		left: 50%
		transform: translateX(-50%)
		width: 60%
		height: 20px
		background: radial-gradient(ellipse at center, rgba(0,0,0,0.15) 0%, transparent 70%)
		border-radius: 50%

	// === Gallery Indicators ===
	.gallery-indicators
		display: flex
		justify-content: center
		align-items: center
		gap: 0.5rem
		padding: 0.5rem 0

	.indicator
		width: 40px
		height: 4px
		background-color: var(--border-color)
		border-radius: 2px
		cursor: pointer
		transition: width 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s ease

		&.active
			width: 60px
			background-color: var(--primary-color)

		&:hover:not(.active)
			background-color: var(--secondary-text-color)

	// === Thumbnail Gallery ===
	.thumbnail-gallery
		display: flex
		gap: 0.75rem
		align-items: stretch
		flex: 3
		min-height: 0

	:global(.qv-thumbnail)
		flex: 1
		max-width: 33.333%
		border-radius: 12px
		overflow: hidden
		cursor: pointer
		border: 1px solid var(--border-color)
		transition: all 0.2s ease
		display: flex
		align-items: center
		justify-content: center
		padding: 8px

		&:hover,
		&.active
			border-color: var(--primary-color)

		img
			max-width: 100%
			max-height: 100%
			object-fit: contain

	// === Full View Link ===
	.full-view-link
		display: flex
		align-items: center
		gap: 1rem
		text-decoration: none
		color: var(--text-color)
		padding: 1rem 1.5rem
		background-color: var(--secondary-bg)
		border-radius: 12px
		transition: all 0.2s ease
		margin-top: auto

		&:hover
			background-color: var(--bg-color)
			box-shadow: 0 4px 12px rgba(0,0,0,0.1)
			color: var(--primary-color)
			transform: translateX(5px)

		.text-content
			display: flex
			flex-direction: column

			.title
				font-weight: 700
				font-size: 0.9rem

			.subtitle
				font-size: 0.75rem
				color: var(--secondary-text-color)

	// === Product Details Section ===
	.product-details-section
		flex: 1
		display: flex
		flex-direction: column
		justify-content: center
		gap: 1.5rem

	.qv-header
		.qv-brand
			font-size: 0.85rem
			color: var(--secondary-text-color)
			text-transform: uppercase
			letter-spacing: 1.5px
			margin-bottom: 0.5rem

		.qv-title
			font-family: $font-family-heading
			font-size: 2rem
			color: var(--text-color)
			margin-bottom: 1rem
			line-height: 1.1
			font-weight: 700

			@include respond-to($tablet)
				font-size: 2.5rem

		.qv-rating
			display: flex
			align-items: center
			color: var(--primary-color)

			.stars
				display: flex
				gap: 0.25rem

	.qv-description
		border-radius: 12px
		font-size: 0.85rem
		color: var(--secondary-text-color)
		line-height: 1.5

	// === Size Selector ===
	.qv-sizes
		display: flex
		flex-wrap: wrap
		gap: 0.5rem
		align-items: center

	.size-option
		display: flex
		align-items: center
		justify-content: center
		min-width: 40px
		height: 40px
		padding: 0 0.75rem
		border-radius: 8px
		border: 1px solid var(--border-color)
		cursor: pointer
		font-size: 0.85rem
		font-weight: 600
		color: var(--text-color)
		background-color: transparent
		transition: all 0.2s ease

		&:hover
			border-color: var(--primary-color)
			color: var(--primary-color)

		&.selected
			background-color: var(--primary-color)
			border-color: var(--primary-color)
			color: #fff

	// === Actions ===
	.qv-actions
		display: flex
		align-items: center
		justify-content: space-between
		margin-top: 1rem
		padding-top: 1.5rem
		border-top: 1px solid var(--border-color)
		gap: 1rem

		.price-block
			display: flex
			flex-direction: column

			.label
				font-size: 0.75rem
				color: var(--secondary-text-color)
				margin-bottom: 0.25rem

			.price
				font-size: 1.75rem
				font-weight: 700
				color: var(--text-color)

	// === Footer ===
	.quick-view-footer
		padding: 1.5rem 2rem
		background-color: var(--secondary-bg)
		display: flex
		justify-content: flex-end

		@include respond-to($tablet)
			padding: 1.5rem 2.5rem

	.full-view-link
		display: flex
		align-items: center
		gap: 1rem
		text-decoration: none
		color: var(--text-color)
		padding: 1rem 1.5rem
		background-color: var(--bg-color)
		border-radius: 12px
		transition: all 0.2s ease
		box-shadow: 0 4px 12px rgba(0,0,0,0.05)

		&:hover
			transform: translateX(5px)
			box-shadow: 0 6px 16px rgba(0,0,0,0.1)
			color: var(--primary-color)

		.text-content
			display: flex
			flex-direction: column
			align-items: flex-end

			.title
				font-weight: 700
				font-size: 1rem

			.subtitle
				font-size: 0.8rem
				color: var(--secondary-text-color)
</style>

<script>
	// Quick View Logic
	const initQuickView = () => {
		const overlay = document.getElementById("quick-view-overlay");
		const backdrop = document.getElementById("quick-view-backdrop");
		const closeBtn = document.getElementById("quick-view-close");

		// Elements to populate
		const img = document.getElementById("qv-image") as HTMLImageElement;
		const brand = document.getElementById("qv-brand");
		const title = document.getElementById("qv-title");
		const price = document.getElementById("qv-price");
		const starsContainer = document.getElementById("qv-stars");
		const fullViewLink = document.getElementById(
			"qv-full-view-link",
		) as HTMLAnchorElement;
		const thumbnailsContainer = document.getElementById("qv-thumbnails");

		if (!overlay) return;

		const closeQuickView = () => {
			overlay.classList.remove("active");
			document.body.style.overflow = "";
		};

		const openQuickView = (data: any) => {
			// Populate data
			if (img) img.src = data.image;
			if (brand) brand.textContent = data.brand;
			if (title) title.textContent = data.title;
			if (price) price.textContent = data.price;

			// Generate stars
			if (starsContainer) {
				starsContainer.innerHTML = "";
				if (data.starsHtml) {
					starsContainer.innerHTML = data.starsHtml;
				}
			}

			// Generate thumbnails (use same image for demo)
			if (thumbnailsContainer && data.image) {
				thumbnailsContainer.innerHTML = "";
				for (let i = 0; i < 3; i++) {
					const thumb = document.createElement("div");
					thumb.className = `qv-thumbnail ${i === 0 ? "active" : ""}`;
					thumb.innerHTML = `<img src="${data.image}" alt="Thumbnail ${i + 1}" />`;
					thumb.addEventListener("click", () => {
						// Update main image
						if (img) img.src = data.image;
						// Update active state
						document
							.querySelectorAll(".qv-thumbnail")
							.forEach((t) => t.classList.remove("active"));
						thumb.classList.add("active");
						// Update carousel
						updateCarouselIndicator(i);
					});
					thumbnailsContainer.appendChild(thumb);
				}
			}

			if (fullViewLink) {
				fullViewLink.href = `/product/${data.id || "1"}`;
			}

			overlay.classList.add("active");
			document.body.style.overflow = "hidden";
		};

		// Gallery indicator update helper
		const updateCarouselIndicator = (activeIndex: number) => {
			const indicators = document.querySelectorAll(
				".gallery-indicators .indicator",
			);
			indicators.forEach((ind, i) => {
				ind.classList.toggle("active", i === activeIndex);
			});
		};

		// Initialize indicator clicks
		const initIndicators = () => {
			const indicators = document.querySelectorAll(
				".gallery-indicators .indicator",
			);
			indicators.forEach((ind, i) => {
				ind.addEventListener("click", () => {
					// Find corresponding thumbnail and click it to trigger update
					const thumbnails = document.querySelectorAll(".qv-thumbnail");
					if (thumbnails[i]) {
						(thumbnails[i] as HTMLElement).click();
					}
				});
			});
		};
		initIndicators();

		// Size selection
		const sizeOptions = document.querySelectorAll(".size-option");
		sizeOptions.forEach((option) => {
			option.addEventListener("click", () => {
				sizeOptions.forEach((o) => o.classList.remove("selected"));
				option.classList.add("selected");
			});
		});

		// Event Listeners
		window.addEventListener("quick-view:open", ((e: CustomEvent) => {
			openQuickView(e.detail);
		}) as EventListener);

		backdrop?.addEventListener("click", closeQuickView);
		closeBtn?.addEventListener("click", closeQuickView);

		// Escape key
		document.addEventListener("keydown", (e) => {
			if (e.key === "Escape" && overlay.classList.contains("active")) {
				closeQuickView();
			}
		});
	};

	initQuickView();
	document.addEventListener("astro:page-load", initQuickView);
</script>
